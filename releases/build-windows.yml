name: Build Windows App

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  build:
    name: Build Installer
    runs-on: windows-latest

    steps:
      # 1. æ‹‰å–ä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. é…ç½® Flutter ç¯å¢ƒ (é”å®š 3.27.0)
      - name: Setup Flutter SDK
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.0'
          channel: 'stable'
          cache: true

      # 3. å®‰è£…ä¾èµ–
      - name: Install Dependencies
        run: flutter pub get

      # 4. å¼€å§‹ç¼–è¯‘
      - name: Build Windows
        run: flutter build windows --release

      # === ğŸ” è°ƒè¯•æ­¥éª¤ (ä¿®æ­£ç‰ˆ) ===
      - name: Check Exe Name
        shell: powershell
        run: |
          # æ”¹ç”¨è‹±æ–‡ï¼Œé¿å…ç¼–ç æŠ¥é”™
          Write-Host "Checking Release directory for .exe files:"
          
          # âš ï¸ æ³¨æ„ï¼šè¿™é‡ŒåŠ ä¸Šäº† x64ï¼Œå› ä¸º Flutter 3.10+ é»˜è®¤è¾“å‡ºåˆ° x64 ç›®å½•
          Get-ChildItem build\windows\x64\runner\Release\*.exe | Select-Object Name

      # 5. ç”Ÿæˆå®‰è£…åŒ… (Inno Setup)
      - name: Build Installer
        shell: powershell
        run: |
          choco install innosetup --no-progress
          
          # 1. ä¸‹è½½ä¸­æ–‡è¯­è¨€åŒ…
          $LangUrl = "https://raw.githubusercontent.com/jrsoftware/issrc/main/Files/Languages/Unofficial/ChineseSimplified.isl"
          Invoke-WebRequest -Uri $LangUrl -OutFile "installers\ChineseSimplified.isl"
          
          # 2. ä¸‹è½½å¾®è½¯ VC++ è¿è¡Œæ—¶å®‰è£…åŒ…
          $VcUrl = "https://aka.ms/vs/17/release/vc_redist.x64.exe"
          Invoke-WebRequest -Uri $VcUrl -OutFile "installers\VC_redist.x64.exe"
          
          # ========================================================
          # 3. [å…³é”®ä¿®å¤] å¼ºåˆ¶æ·»åŠ  BOM å¤´ (è§£å†³ä¸­æ–‡ä¹±ç /è·¯å¾„æŠ¥é”™)
          # ========================================================
          echo "æ­£åœ¨ä¿®æ­£ setup.iss ç¼–ç ä¸º UTF-8 BOM..."
          $IssPath = "installers\setup.iss"
          # Get-Content -Encoding UTF8 ä¼šæ­£ç¡®è¯»å–æ—  BOM çš„ UTF-8 æ–‡ä»¶
          # Set-Content -Encoding UTF8 åœ¨ PowerShell 5.1 ä¸­ä¼šè‡ªåŠ¨æ·»åŠ  BOM
          $Content = Get-Content -Path $IssPath -Encoding UTF8
          Set-Content -Path $IssPath -Value $Content -Encoding UTF8
          
          # 4. ç¼–è¯‘è„šæœ¬
          echo "å¼€å§‹ç¼–è¯‘..."
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" $IssPath

      # 6. ä¸Šä¼ äº§ç‰©
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-app
          path: build/windows/installer/*.exe
          retention-days: 3